package cn.zhuguoqing.operationLog.support.parser;

import org.springframework.aop.support.AopUtils;
import org.springframework.beans.factory.BeanFactory;
import org.springframework.context.expression.AnnotatedElementKey;
import org.springframework.context.expression.BeanFactoryResolver;
import org.springframework.context.expression.CachedExpressionEvaluator;
import org.springframework.expression.EvaluationContext;
import org.springframework.expression.Expression;
import org.springframework.stereotype.Component;

import java.lang.reflect.Method;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * @author guoqing.zhu
 *     <p>description:SpEL表达式相关缓存
 */
@Component
public class LogRecordExpressionEvaluator extends CachedExpressionEvaluator {

  private final Map<ExpressionKey, Expression> expressionCache = new ConcurrentHashMap<>(64);

  private final Map<AnnotatedElementKey, Method> targetMethodCache = new ConcurrentHashMap<>(64);

  public String parseExpression(
      String conditionExpression, AnnotatedElementKey methodKey, EvaluationContext evalContext) {
    Object value =
        getExpression(this.expressionCache, methodKey, conditionExpression)
            .getValue(evalContext, Object.class);
    return value == null ? "" : value.toString();
  }

  /**
   * Create an {@link LogRecordEvaluationContext}.
   *
   * @param method the method
   * @param args the method arguments
   * @param targetClass the target class
   * @param result the return value (can be {@code null}) or
   * @param errorMsg errorMsg
   * @param beanFactory Spring beanFactory
   * @return the evaluation context
   */
  public EvaluationContext createEvaluationContext(
      Method method,
      Object[] args,
      Class<?> targetClass,
      Object result,
      String errorMsg,
      BeanFactory beanFactory) {
    Method targetMethod = getTargetMethod(targetClass, method);
    LogRecordEvaluationContext evaluationContext =
        new LogRecordEvaluationContext(
            null, targetMethod, args, getParameterNameDiscoverer(), result, errorMsg);
    if (beanFactory != null) {
      evaluationContext.setBeanResolver(new BeanFactoryResolver(beanFactory));
    }
    return evaluationContext;
  }

  /**
   * 获取TargetMethod
   *
   * @param targetClass
   * @param method
   * @return
   */
  private Method getTargetMethod(Class<?> targetClass, Method method) {
    AnnotatedElementKey methodKey = new AnnotatedElementKey(method, targetClass);
    Method targetMethod = this.targetMethodCache.get(methodKey);
    if (targetMethod == null) {
      targetMethod = AopUtils.getMostSpecificMethod(method, targetClass);
      this.targetMethodCache.put(methodKey, targetMethod);
    }
    return targetMethod;
  }
}
